___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "GTM to BigQuery",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "@AnalyticaHouse || This is internal request template for inserting table from GTM to BigQuery",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "bq_config",
    "displayName": "BigQuery Configurations",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "TEXT",
        "name": "bq_project",
        "displayName": "BigQuery Project ID",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "bq_dataset",
        "displayName": "BigQuery Dataset",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "bq_table",
        "displayName": "BigQuery Table",
        "simpleValueType": true
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "common_events",
    "displayName": "Common Events",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "TEXT",
        "name": "event_name",
        "displayName": "Event Name",
        "simpleValueType": true
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "send_to_bq",
    "checkboxText": "Send to BigQuery",
    "simpleValueType": true,
    "displayName": "Send to BigQuery",
    "help": "If turn off, your BiqQuery connection will be disabled.",
    "defaultValue": true
  }
]


___SANDBOXED_JS_FOR_SERVER___

const BigQuery = require('BigQuery');
const getAllEventData = require('getAllEventData');
const logToConsole = require('logToConsole');
const getTimestamp = require('getTimestamp');
const JSON = require('JSON');



//Default Common Events
const eventName = data.event_name;


//BigQuery 
const projectID = data.bq_project;
const datasetId = data.bq_dataset;
const tableId = data.bq_table;

//Config
const sendToBigQuery = data.send_to_bq;


const connectionInfo = {
  'projectId': projectID,
  'datasetId': datasetId,
  'tableId': tableId
};


const rows = [{ 
  'page_title': getAllEventData().page_title,
  'client_id': getAllEventData().client_id,
  'event_name': eventName,
}];

logToConsole(rows);

const options = {
  'ignoreUnknownValues': true,
  'skipInvalidRows': true,
};

if (sendToBigQuery) {
BigQuery.insert(connectionInfo, rows, options)
  .then(data.gtmOnSuccess, data.gtmOnFailure);
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_bigquery",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedTables",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "projectId"
                  },
                  {
                    "type": 1,
                    "string": "datasetId"
                  },
                  {
                    "type": 1,
                    "string": "tableId"
                  },
                  {
                    "type": 1,
                    "string": "operation"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 5/6/2022, 8:44:38 AM


